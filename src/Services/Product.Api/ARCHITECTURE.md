# Ki?n trúc Microservices - Product.Api

## ??? T?ng quan ki?n trúc h? th?ng

```
???????????????????????????????????????????????????????????????????
?                        Client / Browser                          ?
???????????????????????????????????????????????????????????????????
                             ?
                             ?
???????????????????????????????????????????????????????????????????
?                      API Gateway (Ocelot)                        ?
?                     Port: 5000 (Gateway)                         ?
??????????????????????????????????????????????????????????????????
      ?         ?         ?         ?         ?         ?
      ?         ?         ?         ?         ?         ?
   ???????  ???????  ???????  ???????  ???????  ???????
   ?Order?  ?Prod ?  ?Cust ?  ?Bask ?  ?Inv  ?  ?Sched?
   ? Api ?  ? Api ?  ? Api ?  ? Api ?  ? Api ?  ? Job ?
   ???????  ???????  ???????  ???????  ???????  ???????
      ?        ?        ?        ?        ?        ?
      ?        ?        ?        ?        ?        ?
   ???????  ???????  ???????  ???????  ???????
   ?SQL  ?  ?MySQL?  ?Postgr? ?Redis?  ?Mongo?
   ?Server? ?     ?  ?SQL   ? ?     ?  ?DB   ?
   ?1435 ?  ?3307 ?  ?5433  ? ?6379 ?  ?27017?
   ???????  ???????  ???????  ???????  ???????
      ?        ?        ?        ?        ?
      ?????????????????????????????????????
                      ?
                      ?
           ????????????????????????
           ?   RabbitMQ (5672)    ?
           ?   Management (15672) ?
           ????????????????????????
                      ?
           ???????????????????????
           ?                     ?
    ????????????          ????????????
    ?Elastic   ?          ? Kibana   ?
    ?Search    ????????????  (5601)  ?
    ? (9200)   ?          ?          ?
    ????????????          ????????????
           ?
           ?
    ????????????????
    ? Health Check ?
    ?  Dashboard   ?
    ????????????????
```

## ?? Product.Api - Chi ti?t ki?n trúc

```
???????????????????????????????????????????????????????????????????
?                        Product.Api Service                       ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
?  ??????????????????????????????????????????????????????????    ?
?  ?              API Layer (Controllers)                    ?    ?
?  ?  - ProductsController                                   ?    ?
?  ?  - Handle HTTP Requests/Responses                       ?    ?
?  ?  - Input Validation                                     ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                        ?                                         ?
?  ??????????????????????????????????????????????????????????    ?
?  ?         Business Logic Layer (Services)                ?    ?
?  ?  - ProductService (Future)                             ?    ?
?  ?  - Business Rules & Validation                         ?    ?
?  ?  - Orchestration                                       ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                        ?                                         ?
?  ??????????????????????????????????????????????????????????    ?
?  ?        Data Access Layer (Repositories)                ?    ?
?  ?  - IProductRepository / ProductRepository              ?    ?
?  ?  - CRUD Operations                                     ?    ?
?  ?  - Query Building                                      ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                        ?                                         ?
?  ??????????????????????????????????????????????????????????    ?
?  ?           Persistence Layer (EF Core)                  ?    ?
?  ?  - ProductContext (DbContext)                          ?    ?
?  ?  - Entity Configurations                               ?    ?
?  ?  - Migrations                                          ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                        ?                                         ?
????????????????????????????????????????????????????????????????
                         ?
                         ?
              ????????????????????
              ?   MySQL Database ?
              ?   Port: 3307     ?
              ?   ProductDb      ?
              ????????????????????
```

## ?? K?t n?i v?i BuildingBlocks

```
Product.Api
    ?
    ???? Common.Logging (Serilog)
    ?       - Console sink
    ?       - Debug sink
    ?       - Elasticsearch sink (future)
    ?
    ???? Infrastructure
    ?       - Repository base classes
    ?       - Generic repository pattern
    ?       - Unit of Work pattern
    ?
    ???? Contracts
    ?       - Shared DTOs
    ?       - API contracts
    ?       - Request/Response models
    ?
    ???? Shared
    ?       - Common utilities
    ?       - Extension methods
    ?       - Helper classes
    ?
    ???? EventBus.Messages
            - RabbitMQ message contracts
            - Event definitions
            - Message publishers/consumers
```

## ?? Data Flow

### Request Flow (GET /api/products)
```
1. Client Request
   ?
   ?
2. API Gateway (Ocelot)
   ? - Route to Product.Api
   ? - Load balancing
   ? - Rate limiting
   ?
3. Product.Api Controller
   ? - Validate request
   ? - Log request
   ?
4. ProductRepository
   ? - Build EF query
   ? - Include related data
   ?
5. MySQL Database
   ? - Execute query
   ? - Return data
   ?
6. Map to DTO
   ? - Entity ? ProductDto
   ? - Hide sensitive data
   ?
7. Return Response
   ? - JSON format
   ? - HTTP 200 OK
   ?
8. Client receives data
```

### Event Flow (Product Created)
```
1. POST /api/products
   ?
   ?
2. ProductRepository.CreateAsync()
   ? - Save to database
   ?
3. Publish Event
   ? - ProductCreatedEvent
   ? - Via MassTransit
   ?
4. RabbitMQ
   ? - Store message
   ? - Route to subscribers
   ?
5. Other Services
   ? - Inventory.Api (update stock)
   ? - Order.Api (product available)
   ? - ScheduleJob (cache refresh)
```

## ??? Database Schema

```sql
-- Categories Table
CREATE TABLE Categories (
    Id BIGINT PRIMARY KEY AUTO_INCREMENT,
    Name VARCHAR(100) NOT NULL,
    Description VARCHAR(500)
);

-- Products Table
CREATE TABLE Products (
    Id BIGINT PRIMARY KEY AUTO_INCREMENT,
    Name VARCHAR(200) NOT NULL,
    Description VARCHAR(1000),
    Price DECIMAL(18,2) NOT NULL,
    StockQuantity INT NOT NULL,
    CategoryId BIGINT NOT NULL,
    CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedDate DATETIME,
    FOREIGN KEY (CategoryId) REFERENCES Categories(Id)
);

-- Indexes
CREATE INDEX IX_Products_CategoryId ON Products(CategoryId);
CREATE INDEX IX_Products_Name ON Products(Name);
```

## ?? Security (Future)

```
???????????????????????????????????????
?         JWT Authentication          ?
???????????????????????????????????????
?  1. User login                      ?
?  2. Identity Server issues token    ?
?  3. Client stores token             ?
?  4. Include token in requests       ?
?  5. API Gateway validates           ?
?  6. Forward to Product.Api          ?
???????????????????????????????????????
```

## ?? Scalability

### Horizontal Scaling
```
    Load Balancer
         ?
    ?????????????????????????????
    ?         ?        ?        ?
Product.Api Product.Api Product.Api Product.Api
Instance 1  Instance 2 Instance 3 Instance 4
    ?         ?        ?        ?
    ?????????????????????????????
              ?
         MySQL Cluster
      (Read Replicas)
```

### Caching Strategy
```
Request ? API ? Check Redis Cache
                ?
                ??? Cache Hit ? Return from cache
                ?
                ??? Cache Miss ? Query MySQL
                                 ?
                                 ??? Store in Redis
                                     ??? Return to client
```

## ?? Testing Strategy

```
1. Unit Tests
   - Repository tests (with In-Memory DB)
   - Service tests (with mocked repos)
   - Validator tests

2. Integration Tests
   - API endpoint tests
   - Database integration tests
   - Event bus tests

3. Performance Tests
   - Load testing
   - Stress testing
   - Spike testing
```

## ?? Deployment

```
Development
    ?
    ?
Docker Compose (local)
    ?
    ?
CI/CD Pipeline
    ?
    ??? Build & Test
    ?
    ??? Build Docker Image
    ?
    ??? Push to Registry
    ?
    ??? Deploy
         ?
         ??? Staging (Kubernetes)
         ?
         ??? Production (Kubernetes)
```
